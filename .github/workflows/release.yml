name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Get Flutter dependencies
      run: flutter pub get
      
    - name: Generate Flutter app icons
      run: flutter pub run flutter_launcher_icons:main
      
    - name: Build Windows exe
      run: |
        flutter build windows --release
        
    - name: Build Android APK (split per ABI)
      run: |
        flutter build apk --release --split-per-abi
        
    - name: Get version from pubspec.yaml
      id: get_version
      run: |
        $version = Select-String -Path "pubspec.yaml" -Pattern "version: (.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "Version: $version"
        
    - name: Create release directory
      run: |
        New-Item -ItemType Directory -Path "release" -Force
        
    - name: Copy Windows exe to release directory
      run: |
        Copy-Item -Path "build\windows\x64\runner\Release\*" -Destination "release\" -Recurse
        Compress-Archive -Path "release\*" -DestinationPath "release\file_transfer_assistant_windows.zip"
        
    - name: Copy Android APKs to release directory
      run: |
        Copy-Item -Path "build\app\outputs\flutter-apk\*.apk" -Destination "release\"
        
    - name: List release files
      run: |
        Get-ChildItem -Path "release" -Name
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.tag || github.ref_name }}
        name: Release ${{ github.event.inputs.tag || github.ref_name }}
        body: |
          ## æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹ - ${{ github.event.inputs.tag || github.ref_name }}
          
          ### ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          **Windows ç‰ˆæœ¬:**
          - `file_transfer_assistant_windows.zip` - Windows å¯æ‰§è¡Œæ–‡ä»¶
          
          **Android ç‰ˆæœ¬:**
          - `app-arm64-v8a-release.apk` - 64ä½ARMè®¾å¤‡ (æ¨è)
          - `app-armeabi-v7a-release.apk` - 32ä½ARMè®¾å¤‡
          - `app-x86_64-release.apk` - 64ä½x86è®¾å¤‡
          
          ### ğŸ“± å®‰è£…è¯´æ˜
          
          **Windows:**
          1. ä¸‹è½½ `file_transfer_assistant_windows.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `file_transfer_assistant.exe`
          
          **Android:**
          1. æ ¹æ®ä½ çš„è®¾å¤‡ç±»å‹ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶
          2. åœ¨æ‰‹æœºä¸Šå®‰è£…APKæ–‡ä»¶
          3. å¦‚æœæ˜¯é¦–æ¬¡å®‰è£…ï¼Œéœ€è¦å…è®¸"æœªçŸ¥æ¥æº"çš„åº”ç”¨å®‰è£…
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. ç¡®ä¿Windowså’ŒAndroidè®¾å¤‡åœ¨åŒä¸€å±€åŸŸç½‘å†…
          2. åœ¨Windowsä¸Šè¿è¡Œç¨‹åºï¼Œä¼šæ˜¾ç¤ºäºŒç»´ç 
          3. ç”¨Androidè®¾å¤‡æ‰«æäºŒç»´ç å³å¯è¿æ¥
          4. å¼€å§‹ä¼ è¾“æ–‡ä»¶
          
          ---
          
          *è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒç‰ˆæœ¬*
        draft: false
        prerelease: false
        files: |
          release/file_transfer_assistant_windows.zip
          release/*.apk
        token: ${{ secrets.GITHUB_TOKEN }}